<!DOCTYPE html>
<html>
  <head>
    <title>Garden</title>
    <link rel="apple-touch-icon" href="flower.png">
    <!-- <meta http-equiv="refresh" content="20"> -->
    <!-- EXTERNAL LIBS-->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script src="https://www.google.com/jsapi"></script>

    <!-- EXAMPLE SCRIPT -->
    <script>

      // onload callback
      function drawCharts() {
        var pages = Number(location.search.split('pages=')[1]) ? location.search.split('pages=')[1] : 10;

        all_data = [];
        var results = [];
        var public_key = 'OG6Wn5ANN5HMXryVqjRm';

        for(var page =1; page < pages; page++ ) {
          var async = $.ajax({
            url:'https://data.sparkfun.com/output/' + public_key + '.json',
            data: {page: page},
            dataType: 'json',
            success: function(data1){
            }
          });
          results.push(async);
        }

        $.when.apply(this, results).done(function() {
          for(var i = 0; i < arguments.length; i++) {
             $.each(arguments[i][0], function (i, row) {
              all_data.push(row);
            });
          }

          drawChart(all_data);
        });

      }


      function drawChart(all_data) {
        var soiltemp_voltage_data = new google.visualization.DataTable();
        soiltemp_voltage_data.addColumn('datetime', 'timestamp');
        soiltemp_voltage_data.addColumn('number', 'soil temperature (F)');
        soiltemp_voltage_data.addColumn('number', 'air temperature (F)');
        soiltemp_voltage_data.addColumn('number', 'solar power (volts)');
        $.each(all_data, function (i, row) {
          soiltemp_voltage_data.addRow([
            (new Date(row.timestamp)),
            parseFloat(row.soiltempf),
            parseFloat(row.tempf),
            parseFloat(row.solarvoltage)/4096.0*3.3*3
            ]);
        });

        var soiltemp_voltage_chart = new google.visualization.LineChart($('#soiltemp_voltage_chart').get(0));

        soiltemp_voltage_chart.draw(soiltemp_voltage_data, {
          title: 'Sun and temperature',
          series: {
            0: {targetAxisIndex: 0},
            1: {targetAxisIndex: 0},
            2: {targetAxisIndex: 1}
          },
          vAxes: {
            0: {title: "temp (f)", viewWindow:{max:20, min:100}},
            1: {title: "voltage", viewWindow:{max:0, min:7}}
          }
        });




        var rain_soilmoisture = new google.visualization.DataTable();
        rain_soilmoisture.addColumn('datetime', 'timestamp');
        rain_soilmoisture.addColumn('number', 'lower soil moisture');
        rain_soilmoisture.addColumn('number', 'upper soil moisture');
        rain_soilmoisture.addColumn('number', 'rain (inches)');
        $.each(all_data, function (i, row) {
          rain_soilmoisture.addRow([
            (new Date(row.timestamp)),
            (4096-parseFloat(row.soilmoisture0))/4096,
            (4096-parseFloat(row.soilmoisture1))/4096,
            parseFloat(row.rainin)
            ]);
        });

        var rain_soilmoisture_chart = new google.visualization.LineChart($('#soilmoisture_chart').get(0));

        rain_soilmoisture_chart.draw(rain_soilmoisture, {
          title: 'Rain and soil moisture',
          series: {
            0: {targetAxisIndex: 0},
            1: {targetAxisIndex: 0},
            2: {targetAxisIndex: 1}
          },
          vAxes: {
            0: {title: "moisture ratio", viewWindow:{max:0.6, min:0.2}},
            1: {title: "inches", viewWindow:{max:0.75, min:0}}
          }
        });



        var winds = new google.visualization.DataTable();
        winds.addColumn('datetime', 'timestamp');
        winds.addColumn('number', 'wind speed 1m average');
        winds.addColumn('number', 'wind gust 10m average');
        $.each(all_data, function (i, row) {
          winds.addRow([
            (new Date(row.timestamp)),
            parseFloat(row.windspeed_avg),
            parseFloat(row.windgust_avg),
            ]);
        });

        var winds_chart = new google.visualization.LineChart($('#winds_chart').get(0));

        winds_chart.draw(winds, {
          title: 'Winds',
          series: {
            0: {targetAxisIndex: 0},
            1: {targetAxisIndex: 1},
          },
          vAxes: {
            0: {title: "mph", viewWindow:{max:15, min:0}},
            1: {title: "gust mph", viewWindow:{max:50, min:0}},

          }

        });


        var humidity_and_hg = new google.visualization.DataTable();
        humidity_and_hg.addColumn('datetime', 'timestamp');
        humidity_and_hg.addColumn('number', 'air humidity');
        humidity_and_hg.addColumn('number', 'barometer (hg)');
        $.each(all_data, function (i, row) {
          humidity_and_hg.addRow([
            (new Date(row.timestamp)),
            parseFloat(row.humidity),
            parseFloat(row.hg),
            ]);
        });

        var humidity_and_hg_chart = new google.visualization.LineChart($('#humidity_and_hg_chart').get(0));

        humidity_and_hg_chart.draw(humidity_and_hg, {
          title: 'Humidity and pressure',
          series: {
            0: {targetAxisIndex: 0},
            1: {targetAxisIndex: 1},
          },
          vAxes: {
            0: {title: "percent", viewWindow:{max:100, min:0}},
            1: {title: "hg", viewWindow:{max:31, min:29}},
          }
        });


      }

      // load chart lib
      google.load('visualization', '1', {
        packages: ['corechart']
      });

      // call drawChart once google charts is loaded
      google.setOnLoadCallback(drawCharts);

    </script>

  </head>
  <body>
    <div id="soiltemp_voltage_chart" style="width: 100%; height: 500px;"></div>
    <div id="soilmoisture_chart" style="width: 100%; height: 500px;"></div>
    <div id="winds_chart" style="width: 100%; height: 500px;"></div>
    <div id="humidity_and_hg_chart" style="width: 100%; height: 500px;"></div>

  </body>
</html>
